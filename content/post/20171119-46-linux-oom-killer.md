---
title: Linux - OOM > out of memory
date: 2017-11-19T00:00:00+08:00
lastmod: 2018-05-22T00:00:00+08:00
categories:
  - Troubleshooting
tags:
  - Linux
  - TiDB
  - OOM
---
## 0x00 å¼€å¤´

æµ‹è¯•æœºå™¨ç¯å¢ƒé…ç½®æ¯”è¾ƒä½ï¼Œä½¿ç”¨ TiDB Join è¡¨è¿æ¥æŸ¥è¯¢æ—¶å¶å°”ä¼šå‡ºç°é‡å¯ç°è±¡ï¼ŒæŒ‰ç…§å®˜æ–¹æŒ‡å¯¼æŸ¥çœ‹é—®é¢˜åŸå› è¯´æ—¶ TiDB-server OOM äº†ï¼Œé‚£ä¹ˆ OOM æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆ OOM å•Šï¼Ÿæ€ä¹ˆæ‰èƒ½é¿å… OOM å‘¢ï¼Ÿ  
æ€è€ƒè¿™ä¸ªç°è±¡çš„æ—¶å€™åœ¨ç½‘ä¸Šæœåˆ°äº†ä¸€äº›å†…å®¹ï¼Œåœ¨æœ¬æ–‡æ€»ç»“ä¸‹ï¼ˆ~~ä»å…¶ä»–å®¶å¤åˆ¶åˆ°è‡ªå·±å®¶~~ï¼‰  

## 0x01 ç°è±¡

TiDB-server è¿è¡Œåœ¨ä¸€ä¸ª 8U 8G çš„è™šæ‹Ÿæœºä¸Šï¼Œæœ‰æ—¶å€™ BDA å†™å‡ºä¸€äº›ç¥å¥‡çš„ SQL åœ¨ TiDB-server ä¸Šè¿è¡Œçš„ä¼šå¯¼è‡´å†…å­˜ç¬é—´ä¸Šæ¶¨ï¼›æ ¹æ®éœ€è¦æŸ¥è¯¢çš„æ•°æ®é‡çº§ï¼Œå¯èƒ½ä¼šç¬é—´å¯¼è‡´å†…å­˜çˆ†ç‚¸ç„¶åè§¦å‘ TiDB-server é‡å¯ã€‚  
é€šè¿‡ä»¥ä¸‹ä¸‰ç§æ–¹å¼äº¤å‰éªŒè¯ TiDB-server æ˜¯å¦æ˜¯ OOMï¼š

1. å†…å­˜åœ¨ç”¨çŠ¶æ€å¯ä»¥åœ¨ç›‘æ§ä¸Šçœ‹åˆ°ä¸€ä¸ªä¸Šæ¶¨è¶‹åŠ¿ï¼Œä½ç½®åœ¨ `TiDB-dashboard > server > memory` æŸ¥çœ‹ï¼Œå‡ºç°é‡å¯çš„ç°è±¡å°±æ˜¯å†…å­˜ç¬é—´ä¸Šæ¶¨ç„¶åå‡ºç°æ–­å´–å¼ä¸‹é™ã€‚  
2. é“¾æ¥ TiDB-server çš„ mysql å®¢æˆ·ç«¯ä¼šå‡ºç°ä¸€æ¡ä¿¡æ¯è¿”å› `ERROR 2013 (HY000): Lost connection to MySQL server during query`
3. ä½¿ç”¨ root ç”¨æˆ·ç™»å½• Linux ç³»ç»Ÿï¼Œç„¶åæ‰§è¡Œ `dmesg -T | grep -i oom` å‘½ä»¤ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç›¸åº”ä¿¡æ¯è¿”å›
   - dmesg è®°å½•äº†ç¡¬ä»¶å¯åŠ¨åè‡ªæ£€ä¿¡æ¯ã€kernel ç³»ç»Ÿè¿è¡Œä¿¡æ¯

## 0x02 åŸå› 

TiDB-server ç›¸æ¯” mysql ï¼Œæœ¨æœ‰ä¸´æ—¶ç‰©ç†è¡¨ã€æœ¨æœ‰ä¸­é—´æ•°æ®è½¬å­˜ç£ç›˜ã€‚æ‰€ä»¥å½“ client å‘èµ·è¯·æ±‚ä» TiDB è·å–å¤§é‡æ•°æ®æ—¶ï¼ŒTiDB éœ€è¦ä» TiKV è·å–æ•°æ®ç„¶ååœ¨ TiDB-server å†…å­˜ä¸­åšè®¡ç®—ï¼Œæ­¤å¤„çš„è®¡ç®—ä¼šé€ æˆå†™æ”¾å¤§ï¼Œç„¶åå†…å­˜çˆ†ç‚¸å¯¼è‡´è§¦å‘ Linux OOM æœºåˆ¶ã€‚

è¿™ä¸ªç°è±¡å½±å“ç¨‹åº¦ä¸å®šï¼Œå¦‚æœæ˜¯åœ¨çº¿è”æœºæœåŠ¡é‡è§è¿™ç§æƒ…å†µå°±æ˜¯æ—¥äº†ğŸ¶å•¦ï¼Œå¦‚æœæ˜¯æµ‹è¯•æˆ–è€…å†…éƒ¨äººå‘˜ä½¿ç”¨è¿˜å¥½ï¼Œå¤§å®¶é‡æ–°æ‰§è¡Œä¸ªæŸ¥è¯¢å°±å¥½äº†ã€‚è¯¥ç°è±¡æœ¨æœ‰å•¥å®Œç¾è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥è€ƒè™‘æ‰¾ä¸ªè¶…å¤§å†…å­˜æœºå™¨éƒ¨ç½² TiDB-server ã€æˆ–è€…è®© DBA å¤„ç†æ•°æ®æ—¶ç¼©å°èŒƒå›´ï¼ˆä¸æ˜æ‰€ä»¥ï¼‰ã€‚

## 0x03 OOM

> linux OOM killerï¼ˆOut Of Memory killerï¼‰è¿™ä¸ªä¸œè¥¿ä¼šåœ¨ç³»ç»Ÿå†…å­˜è€—å°½çš„æƒ…å†µä¸‹è·³å‡ºæ¥ï¼Œé€‰æ‹©æ€§çš„å¹²æ‰ä¸€äº›è¿›ç¨‹ä»¥æ±‚é‡Šæ”¾ä¸€äº›å†…å­˜ï¼ˆ~~ä¸è´Ÿè´£çš„ä¸ªäººç»éªŒï¼šè¿™æŠŠåˆ€æ€çš„æ˜¯å‹æ­»éª†é©¼çš„æœ€åä¸€æ ¹ç¨»è‰ï¼Œå¹¶ä¸æ˜¯æ…åˆ€å­æœ€å¤šçš„äºº~~ï¼‰  
> Linux ä¸‹æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸ª OOM æƒé‡ï¼Œåœ¨ `/proc/<pid>/oom_adj` é‡Œé¢ï¼Œæƒé‡æ˜¯ -17 ~~ +15  
> åŒæ—¶ OOM killer ä¼šè®¡ç®—ä¸€ä¸ªå« score çš„ä¸œä¸œ `/proc/<pid>/oom_score` ï¼Œå¤©é»‘é—­çœ¼ä¹‹åç”¨æ¥ç¡®å®šè¦è¢«æ€çš„äººï¼›è¿™ä¸ªå€¼æ˜¯ç³»ç»Ÿæ”¶é›† è¿›ç¨‹çš„å†…å­˜æ¶ˆè€—é‡ï¼ˆè®¡ç®—æ—¶ï¼šçˆ¶è¿›ç¨‹ä¼šæ‰¿åŒ…æ‰€æœ‰å­è¿›ç¨‹çš„å†…å­˜å ç”¨ï¼‰ã€CPU æ—¶é—´ (utime + stime)ã€ç”Ÿå­˜æ—¶é—´ (uptime - start time)ã€oom_adj ç»¼åˆè®¡ç®—ä¹‹åçš„ç»“æœ  
> æ¶ˆè€—å†…å­˜è¶Šå¤šåˆ†è¶Šé«˜ï¼Œå­˜æ´»æ—¶é—´è¶Šé•¿åˆ†è¶Šä½ == â€œæŸå¤±æœ€å°‘çš„å·¥ä½œï¼Œé‡Šæ”¾æœ€å¤§çš„å†…å­˜åŒæ—¶ä¸ä¼¤åŠæ— è¾œçš„ç”¨äº†å¾ˆå¤§å†…å­˜çš„è¿›ç¨‹ï¼Œå¹¶ä¸”æ€æ‰çš„è¿›ç¨‹æ•°å°½é‡å°‘â€

å‹å¥½æ–¹å¼äººå·¥æ§åˆ¶é™ä½è¢«æ€å‡ ç‡ï¼Œè¾£ä¹ˆå°±æ˜¯æ§åˆ¶è¿›ç¨‹çš„æƒé‡ï¼Œæ¯”å¦‚è¿™æ ·è°ƒæ•´ `echo -17 > /proc/$PID/oom_adj` â€œæºç è¯´ -17 å¯ä»¥ç¦æ­¢è¿›ç¨‹è¢« OOMï¼Œ15 ä¼šæœ€å¤§å‡ ç‡è¢«æ‰“æ­»â€

è¿˜æœ‰ä¸ªä¸é‚£ä¹ˆå‹å¥½çš„æ–¹æ¡ˆï¼š

- ä¿®æ”¹å‚æ•° `/proc/sys/vm/overcommit_memory` å¯ä»¥æ§åˆ¶è¿›ç¨‹å¯¹å†…å­˜è¿‡é‡ä½¿ç”¨çš„åº”å¯¹ç­–ç•¥
  - `overcommit_memory=0` å…è®¸è¿›ç¨‹è½»å¾®è¿‡é‡ä½¿ç”¨å†…å­˜ï¼Œä½†å¯¹äºç¬é—´å¤§å®¹é‡å†…å­˜å ç”¨è¯·æ±‚åˆ™ä¸å…è®¸ã€é»˜è®¤å€¼ã€‘
    - å•æ¬¡ç”³è¯·çš„å†…å­˜å¤§å°ä¸èƒ½è¶…è¿‡ ã€free memory + free swap + pagecache å¤§å° + SLAB ä¸­å¯å›æ”¶çš„éƒ¨åˆ†ã€‘ï¼Œå¦åˆ™æœ¬æ¬¡ç”³è¯·å¤±è´¥ã€‚
  - `overcommit_memory=1` æ°¸è¿œå…è®¸è¿›ç¨‹ overcommit
  - `overcommit_memory=2` æ°¸è¿œç¦æ­¢ overcommit

> æœ¬æ®µå†…å®¹å¤åˆ¶äº [LINUX MEMORY OVERCOMMIT](http://linuxperf.com/?p=102)

overcommit è¿˜æœ‰ä¸ªå»¶ä¼¸å†…å®¹ï¼Œé‚£å°±æ˜¯æ€ä¹ˆåˆ¤æ–­ä»€ä¹ˆæ˜¯ overcommitï¼ŸLinux å†…æ ¸è®¾ç½®äº†ä¸ªå†…å­˜é˜ˆå€¼å¼€å…³ï¼Œè¶…è¿‡å¼€å…³åç›´æ¥å¹²æ‰ã€‚æ‰€ä»¥é…ç½®æˆ overvcommit æ—¶æ³¨æ„ä¿®æ”¹å‚æ•° `/proc/meminfo`

```shell
# grep -i commit /proc/meminfo
CommitLimit:     5967744 kB
Committed_AS:    5363236 kB
```

CommitLimit å°±æ˜¯ overcommit çš„é˜ˆå€¼ï¼Œç”³è¯·çš„å†…å­˜æ€»æ•°è¶…è¿‡ CommitLimit çš„è¯å°±ç®—æ˜¯ overcommitã€‚  
è¿™ä¸ªé˜ˆå€¼æ˜¯å¦‚ä½•è®¡ç®—å‡ºæ¥çš„å‘¢ï¼Ÿå®ƒæ—¢ä¸æ˜¯ç‰©ç†å†…å­˜çš„å¤§å°ï¼Œä¹Ÿä¸æ˜¯ free memory çš„å¤§å°ï¼Œå®ƒæ˜¯é€šè¿‡å†…æ ¸å‚æ•° vm.overcommit_ratio æˆ– vm.overcommit_kbytes é—´æ¥è®¾ç½®çš„ï¼Œå…¬å¼å¦‚ï¼š`CommitLimit = (Physical RAM * vm.overcommit_ratio / 100) + Swap`

vm.overcommit_ratio æ˜¯å†…æ ¸å‚æ•°ï¼Œç¼ºçœå€¼æ˜¯ 50ï¼Œè¡¨ç¤ºç‰©ç†å†…å­˜çš„ 50%ã€‚å¦‚æœä½ ä¸æƒ³ä½¿ç”¨æ¯”ç‡ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šå†…å­˜çš„å­—èŠ‚æ•°å¤§å°ï¼Œé€šè¿‡å¦ä¸€ä¸ªå†…æ ¸å‚æ•° vm.overcommit_kbytes å³å¯.
å¦‚æœä½¿ç”¨äº† huge pagesï¼Œé‚£ä¹ˆéœ€è¦ä»ç‰©ç†å†…å­˜ä¸­å‡å»ï¼Œå…¬å¼å˜æˆï¼š`CommitLimit = ([total RAM] â€“ [total huge TLB RAM]) * vm.overcommit_ratio / 100 + swap`
å‚è§ https://access.redhat.com/solutions/665023

/proc/meminfo ä¸­çš„ Committed_AS è¡¨ç¤ºæ‰€æœ‰è¿›ç¨‹å·²ç»ç”³è¯·çš„å†…å­˜æ€»å¤§å°ï¼Œï¼ˆæ³¨æ„æ˜¯å·²ç»ç”³è¯·çš„ï¼Œä¸æ˜¯å·²ç»åˆ†é…çš„ï¼‰ï¼Œå¦‚æœ Committed_AS è¶…è¿‡ CommitLimit å°±è¡¨ç¤ºå‘ç”Ÿäº† overcommitï¼Œè¶…å‡ºè¶Šå¤šè¡¨ç¤º overcommit è¶Šä¸¥é‡ã€‚Committed_AS çš„å«ä¹‰æ¢ä¸€ç§è¯´æ³•å°±æ˜¯ï¼Œå¦‚æœè¦ç»å¯¹ä¿è¯ä¸å‘ç”Ÿ OOM (out of memory) éœ€è¦å¤šå°‘ç‰©ç†å†…å­˜ã€‚

æŸ¥çœ‹å†…å­˜ä½¿ç”¨çŠ¶å†µçš„å¸¸ç”¨å·¥å…· sar -r ï¼Œè¾“å‡ºç»“æœä¸­æœ‰ä¸¤ä¸ªä¸ overcommit æœ‰å…³ï¼Œkbcommit å’Œ %commit  

- kbcommit å¯¹åº” / proc/meminfo ä¸­çš„ Committed_AS
- %commit çš„è®¡ç®—å…¬å¼å¹¶æ²¡æœ‰é‡‡ç”¨ CommitLimit ä½œåˆ†æ¯ï¼Œè€Œæ˜¯ Committed_AS/(MemTotal+SwapTotal)ï¼Œæ„æ€æ˜¯_å†…å­˜ç”³è¯·_å _ç‰©ç†å†…å­˜ä¸äº¤æ¢åŒºä¹‹å’Œ_çš„ç™¾åˆ†æ¯”

```shell
$ sar -r

05:00:01 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
05:10:01 PM    160576   3648460     95.78         0   1846212   4939368     62.74   1390292   1854880         4
```

è¯¾å¤–é˜…è¯» [How to Configure the Linux Out-of-Memory Killer](https://www.oracle.com/technical-resources/articles/it-infrastructure/dev-oom-killer.html)
