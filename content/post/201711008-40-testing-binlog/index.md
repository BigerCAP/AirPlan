---
title: TiDB - Binlog æ•°æ®åŒæ­¥æž¶æž„æµ‹è¯•
date: 2017-10-08T00:00:00+08:00
lastmod: 2017-11-20T00:00:00+08:00
categories:
  - TiDB
tags:
  - Binlog
  - testing
  - etcd-ctl
  - pd-ctl
---
## 0x00 æµ‹è¯•

å‰æ®µæ—¶é—´éƒ¨ç½²äº†ä¸€å¥— TiDB æ•°æ®åº“ï¼Œåªæœ‰å•çº¯çš„æ•°æ®åº“æ”¾å…»æ˜¯è‚¯å®šä¸è¡Œçš„ã€‚è¿˜è¦ä¸€äº›ç¾å¤‡æ–¹æ¡ˆæ»¡è¶³åˆ åº“è·‘è·¯ä¹‹åŽçš„æ¢å¤å·¥ä½œã€‚  
æŒ‰ç…§ä»¥å¾€ï¼ˆmysqlï¼‰ç»éªŒæœ‰ç‰©ç†ï¼ˆæ–‡ä»¶å†·å­˜ï¼‰å¤‡ä»½ï¼ˆxbackupï¼‰& é€»è¾‘ï¼ˆçƒ­å¤‡ï¼‰å¤‡ä»½ï¼ˆ SQL è¯­å¥åŒæ­¥ï¼‰ï¼›ç„¶ TiDB åº•å±‚ä¸Ž mysql ä¸ä¸€æ ·ï¼Œæ²¡æœ‰ç±»ä¼¼ xbackup ç±»ä¼¼çš„å·¥å…·åšç‰©ç†å¤‡ä»½ï¼ˆæµ‹è¯•è¿‡ç¨‹æ˜¯å‘çŽ°ä¸€ä¸ª~~å¥‡æŠ€æ·«å·§~~åš*ç±»ç‰©ç†å¤‡ä»½*ï¼‰ï¼›é‚£ä¹ˆæŽ¥ä¸‹æ¥è¿˜æœ‰é€»è¾‘å¤‡ä»½æµ‹è¯•ï¼Œè¿™éƒ¨åˆ†æœ‰ PingCAP å®˜æ–¹æä¾›çš„ TiDB-Binlog ç»„ä»¶æ¥æ”¯æŒã€‚  
æ²¡çŽ©è¿‡çš„ä¸œè¥¿å…ˆæ‰¾ä¸ªå°çŽ¯å¢ƒéšæ„æŠ˜è…¾ä¸‹ï¼ŒæŠ˜è…¾åˆ°æ­»ä½ç½®â€¦â€¦

> å…ˆçœ‹ä¸‹ TiDB-binlog æž¶æž„ï¼Œå¦‚å›¾ï¼ˆ20171008 å¤åˆ¶äºŽå®˜æ–¹ç½‘ç«™ï¼‰:

![Binlog 1.0 tidb pump socket drainer](./binlog-1.0-architecture.jpeg)

### ç»„ä»¶

> ç›´æŽ¥å¤åˆ¶å®˜ç½‘å†…å®¹

TiDB-Binlog æ”¯æŒä»¥ä¸‹åŠŸèƒ½åœºæ™¯:  

æ•°æ®åŒæ­¥: åŒæ­¥ TiDB é›†ç¾¤æ•°æ®åˆ°å…¶ä»–æ•°æ®åº“  
å®žæ—¶å¤‡ä»½å’Œæ¢å¤: å¤‡ä»½ TiDB é›†ç¾¤æ•°æ®ï¼ŒåŒæ—¶å¯ä»¥ç”¨äºŽ TiDB é›†ç¾¤æ•…éšœæ—¶æ¢å¤  

PUMPï¼šPump æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œåœ¨æ¯ä¸ª TiDB çš„ä¸»æœºä¸ŠåŽå°è¿è¡Œã€‚ä»–çš„ä¸»è¦åŠŸèƒ½æ˜¯å®žæ—¶è®°å½• TiDB äº§ç”Ÿçš„ Binlog å¹¶é¡ºåºå†™å…¥ç£ç›˜æ–‡ä»¶  

Drainerï¼šDrainer ä»Žå„ä¸ª Pump èŠ‚ç‚¹æ”¶é›† Binlogï¼Œå¹¶æŒ‰ç…§åœ¨ TiDB ä¸­äº‹åŠ¡çš„æäº¤é¡ºåºè½¬åŒ–ä¸ºæŒ‡å®šæ•°æ®åº“å…¼å®¹çš„ SQL è¯­å¥ï¼Œæœ€åŽåŒæ­¥åˆ°ç›®çš„æ•°æ®åº“æˆ–è€…å†™åˆ°é¡ºåºæ–‡ä»¶  

> âš ï¸ éœ€è¦ä¸ºä¸€ä¸ª TiDB é›†ç¾¤ä¸­çš„æ¯å° TiDB server éƒ¨ç½²ä¸€ä¸ª pumpï¼Œç›®å‰ TiDB server åªæ”¯æŒä»¥ unix socket æ–¹å¼çš„è¾“å‡º binlog  

## 0x01 éƒ¨ç½²

### ansible

> é€šè¿‡ä¿®æ”¹ inventory.ini æ–‡ä»¶ä¸­çš„ enable_binlog å¼€å…³ç¡®å®šæ˜¯å¦éƒ¨ç½² Binlogï¼Œé’ˆå¯¹ç¬¬ä¸€æ¬¡éƒ¨ç½²æ—¶æ–¹ä¾¿  
> å¦‚æžœå·²ç»éƒ¨ç½²äº† TiDB-server ï¼Œå°±è¦ä½¿ç”¨ deploy + stop + start ä¸‰æ¿æ–§è§£å†³äº†  

### manual

> å…ˆéƒ¨ç½² PUMP æœåŠ¡ï¼Œå¹¶åœ¨å¯åŠ¨å‚æ•°ç”Ÿå‘½ unix-socket ä¿¡æ¯ï¼Œç›¸å½“äºŽç”Ÿå‘½äº†ä¸€ä¸ªæœåŠ¡ç«¯æŽ¥å£  
> ç„¶åŽé…ç½® TiDB å¯åŠ¨å‚æ•°ï¼Œå¡«å†™ PUMP çš„ unix-socket è·¯å¾„ä¿¡æ¯ï¼ŒTiDB & PUMP åªèƒ½ä¸€å¯¹ä¸€æœåŠ¡ï¼Œä¸èƒ½è·¨æœºå™¨ã€ä¸èƒ½ä¸€å¯¹å¤šä½¿ç”¨  
> å¯åŠ¨ä¼˜å…ˆçº§ä¸ºï¼š PUMP > TiDB  
> åœæ­¢ä¼˜å…ˆçº§ä¸º TiDB > PUMP  

## 0x02 å¸¸è§„

å½“ PUMP & TiDB éƒ½å¯åŠ¨åŽï¼Œå¯åŠ¨ Drainer ï¼›æŒ‰ç…§å®˜æ–¹æ‰‹å†Œå†™é…ç½®æ–‡ä»¶è¾“å‡ºåˆ°ä¸‹æ¸¸çš„ä¸€ä¸ª mysql èŠ‚ç‚¹ï¼ˆæ­¤å¤„çœç•¥ mysql å¯åŠ¨æ–¹å¼ï¼Œdocker run æœ€çœäº‹ï¼‰ã€‚  
ç„¶åŽåœ¨ä¸Šæ¸¸æ‰§è¡Œå„ç§ CDUR / å¢žåˆ æ”¹æŸ¥ DML å·¥ä½œã€DDL å·¥ä½œï¼Œçœ‹ä¸‹æ¸¸å“åº”ã€‚

> æ­¤å¤„âš ï¸ä¸€ä¸ªäº‹æƒ…ï¼šDrainer æœ‰ä¸ª `ignore-schemas = "INFORMATION_SCHEMA,PERFORMANCE_SCHEMA,mysql"` å‚æ•°ï¼Œé»˜è®¤è¿™é‡Œæ˜¯ä¸åŒæ­¥ mysql ä¿®æ”¹çš„ï¼Œå¦‚æžœä½¿ç”¨ update è¯­å¥ä¿®æ”¹ user å¯†ç ï¼Œä¸‹æ¸¸ä¸ä¼šæ›´æ”¹ã€‚  
> è¿˜æœ‰ä¸€ä¸ªå‚æ•°æ˜¯ `replicate-do-db` åªåŒæ­¥é‚£äº›åº“ï¼Œè¿™ä¸ªä¼˜å…ˆçº§æ¯”ä¸Šé¢é‚£ä¸ª ignore è¦é«˜ï¼Œå¹¶ä¸”è®¾ç½®äº†è¿™ä¸ªåŽå°±åªåŒæ­¥è¿™ä¸ªæ•°æ®åº“äº†â€¦â€¦ï¼ˆæŒ‰ç…§è¯­ä¹‰ç†è§£è²Œä¼¼æ²¡å•¥æ¯›ç—…ï¼Œä¸åæ§½äº†ï¼‰  
> âš ï¸ PSï¼šå¦‚æžœæœ‰ä¸åŒçš„æ•°æ®åº“åŒæ­¥åˆ°ä¸åŒçš„ä¸‹æ¸¸ï¼Œéœ€è¦å¯åŠ¨å¤šä¸ª Drainer æ¥å·¥ä½œæ‰èƒ½å®Œæˆè¿™ä¸ªåœºæ™¯  

ä¸»æœºæ€§èƒ½æœ‰é™ï¼Œå®˜æ–¹æ–‡æ¡£è¯´é€šè¿‡ `txn-batch = 1` & `worker-count = 1` å¯ä»¥é…ç½®åŒæ­¥é€Ÿåº¦æµæŽ§ï¼Œç®€å•ç”¨ sysbench åˆ›å»ºäº† 15 å¼ è¡¨ï¼Œæ¯å¼ è¡¨ 10w æ•°æ®ï¼Œä¸Šæ¸¸å¾ˆç•…å¿«çš„æ’å…¥æˆåŠŸï¼›ç„¶åŽé»˜é»˜çœ‹ç€ mysql æ•°æ®çš„åŒæ­¥ã€åæ­£æ€»ä¼šæœ‰äº›å»¶è¿Ÿã€‚ã€æˆ‘è¿™ä¸Šä¸‹æ¸¸éƒ½æ˜¯é…ç½® Binlog åŽäº§ç”Ÿçš„æ–°æ•°æ®ï¼Œä¸å­˜åœ¨è€æ•°æ® mydumper + loader çš„è¿‡ç¨‹ï¼Œè¿™éƒ¨åˆ†å’Œ mysql çš„ mysql dumper + mysql laod æ˜¯ä¸€æ ·çš„ï¼Œå°±ä¸æµ‹è¯•äº†ã€‘  

### å®…ç”·

ç®€å•çš„ç¾éš¾åœºæ™¯ç®€å•æµ‹è¯•äº†ä¸‹ï¼š

1. æ¯”å¦‚æŸä¸ª PUMP æŒ‚æŽ‰äº†ï¼Œå› ä¸ºæœ‰å¤šä¸ª TiDB-serverï¼Œå¿…é¡»è¦æ¯ä¸ª TiDB-server é…ç½®ä¸€ä¸ª PUMPï¼›å•ä¸ª PUMP æŒ‚æŽ‰ä¹‹åŽ TiDB-server ä¹Ÿå°±æŒ‚æŽ‰äº†â€¦â€¦ï¼ˆå¥½å§ï¼Œæˆ‘å¿äº†ï¼Œæ¯•ç«Ÿå®˜æ–¹è¯´å¦‚æžœä¸åœ TiDB-server é‚£ä¹ˆ PUMP æ•…éšœåŽçš„ SQL BINLOG å°±ä¸¢å¤±è®°å½•äº†ï¼Œå¯æ˜¯æˆ‘ä¸šåŠ¡ä¹Ÿæ–­æŽ‰äº†ã€‚è¿™é‡Œå¹¶æ²¡æœ‰æä¾›å•¥å­é€‰æ‹©ã€‚æ¯”å¦‚æˆ‘æƒ³åšä¸ªå¥½äººï¼‰  
2. PUMP æ‰€åœ¨æœºå™¨ç£ç›˜åæŽ‰äº†ï¼Œè§£å†³æ–¹æ¡ˆå°±æ˜¯é‡æ–°åšä¸€å¥— Binlog æµç¨‹ã€‚ï¼ˆmysql è²Œä¼¼ä¹Ÿæ˜¯è¿™æ ·ï¼‰
3. Drainer éœ€è¦é“¾æŽ¥ PD èŽ·å–åˆ° PUMP ä¿¡æ¯ï¼Œå¦‚æžœ PD åœ°å€å†™é”™äº†ï¼Œè¾£ä¹ˆè¦ä¹ˆå¤±è´¥ã€è¦ä¹ˆå†™é”™æ•°æ®ï¼Œè²Œä¼¼æ²¡å•¥æ ¡éªŒè¡Œä¸º
4. Drainer å¯åŠ¨æ—¶æœ‰ä¸ª init tso çš„å‚æ•°ï¼Œæç¤ºä»Žå“ªé‡Œå¼€å§‹åŒæ­¥ã€‚å¦‚æžœå†™é”™äº†è¾£ä¹ˆæ•°æ®å°±ä¸å¾—è€ŒçŸ¥äº† ï¼ˆå’Œ mysql ä¸€ä¸ªè¡Œä¸ºï¼Œæœ¨çš„å•¥é—®é¢˜ï¼‰
5. æ•°æ®è¿‡æ»¤è¡Œä¸ºåªåœ¨ Drainer ä¸Šæœ‰ï¼ŒPUMP ä¸Šæœ¨æœ‰ï¼›å¦‚æžœä¸Šæ¸¸ 100 ä¸ªåº“ï¼Œåªæœ‰ä¸€ä¸ªåº“åŒæ­¥ã€‚è¾£ä¹ˆä½ æ‡‚çš„ã€‚
6. è·¨æœºæˆ¿è¡Œä¸ºï¼Œæ¯”å¦‚ PUMP & Drainer åœ¨ä¸¤ä¸ªæœºæˆ¿ï¼Œä¼šå‡ºçŽ°å»¶è¿ŸåŠ å¤§ï¼ˆä¸Ž mysql ä¸€æ ·ï¼Œä¸€æ ·å¯ä»¥æ–­ç‚¹ç»­ä¼ ï¼Œæ¯•ç«Ÿè¿™æ˜¯å¢žé‡åŒæ­¥åŸºæœ¬åŠŸèƒ½ï¼‰ï¼Œå…¶ä»–å°±æ˜¯æœ‰å¯èƒ½æ—¶æ–­æ—¶è¿žï¼Œdrainer çš„æ–­æ˜¯è¿›ç¨‹æŒ‚æŽ‰ï¼Œæ‰€ä»¥ ansible é‡Œæœ‰ä¸ª supervise çš„ä¸œè¥¿ä¸€ç›´ä¸€ç›´ä¸€ç›´çš„ç­‰ä»–æŒ‚æŽ‰ï¼Œç„¶åŽåˆä¸€ç›´ä¸€ç›´ä¸€ç›´çš„æ‹‰èµ·ä»–ã€‚å³æ—¶ draienr ä¸æ˜¯å› ä¸ºç½‘ç»œæŒ‚æŽ‰ï¼Œæ¯”å¦‚ DDL ã€DML å¡ä½äº†â€¦â€¦ï¼ˆç„¶åŽã€è²Œä¼¼ã€å¤§æ¦‚ã€å¯èƒ½ã€ä¼¼ä¹Žå‘Šè­¦å°±å»¶è¿Ÿäº†ï¼‰  

åŽé¢æš‚æ—¶æƒ³ä¸åˆ°äº†ï¼Œå°±ä¸æµ‹äº†ï¼Œè¿™å¥—æµç¨‹å¤ªé•¿äº†ï¼›æŠ˜è…¾åäº†ä¹‹åŽè¦ç ”ç©¶åŠä¸ªå¤šå°æ—¶æ‰èƒ½ä¿®å¥½â€¦â€¦

## 0x03 æŠ˜è…¾

> æ—¢ç„¶æ˜¯æŠ˜è…¾ï¼Œæ€»éœ€è¦ä¸€äº›æ‰‹æ®µæŸ¥é—®é¢˜ï¼Œåœ¨ä¸Žå®˜æ–¹ç ”å‘æ²Ÿé€šä¸­æ€»ç»“å‡ºæ¥çš„ä¸œä¸œ

å‡ºé—®é¢˜æŽ’æŸ¥æµç¨‹å¤§è‡´åˆ†ä»¥ä¸‹å‡ æ­¥ï¼š

1. å…ˆæŸ¥ TiDB-Server & PUMP ä¹‹é—´çš„çŠ¶æ€
   1. PUMP ç£ç›˜å†™æ»¡äº†ä¹ˆ
   2. TiDB-server ä½¿ç”¨ unix-socket å‚æ•°äº†ä¹ˆ
2. åœ¨æŸ¥ PUMP & Drainer é“¾æŽ¥
   1. Drainer PD URL å†™å¯¹äº†ä¹ˆ
   2. Drainer é…ç½®æ–‡ä»¶ä¸­çš„ ignoreã€replicate-do-dbã€å†™æ­£ç¡®äº†ä¹ˆ
   3. æŸ¥ Drainer data-dir ç›®å½•ä¸‹æ˜¯å¦æœ‰ savepoint æ–‡ä»¶ï¼Œå†…å®¹æ˜¯å¦æ›´æ–°ï¼ˆæœ‰æ—¶å€™æ•°æ®ä¸€ç›´åŒæ­¥ï¼Œä½†æ˜¯æ–‡ä»¶ä¸æ›´æ–°ï¼‰
   4. Drainer ä¸ç¡®å®šæ˜¯å¦å·¥ä½œï¼Œé‚£å°±è°ƒæˆ PD æ¨¡å¼å§ï¼Œå…ˆçœ‹çœ‹æœ‰æœ¨æœ‰ PB æ–‡ä»¶ï¼ˆè¿™ä¸ª PB æ˜¯ä¸ªæ–‡æœ¬ç¼–ç æ ¼å¼ï¼Œç”¨ vi æ‰“å¼€å°±æ˜¯ä¹±ç ï¼Œéœ€è¦è§£ç æ‰èƒ½çœ‹ï¼Œæœ protobuf
3. æŸ¥ PD ä¸­çš„ä¸€äº›ä¿¡æ¯
   1. éœ€è¦ç”¨åˆ°ä¸€ä¸ª etcd-ctl å·¥å…·ï¼Œè¯»å– PUMPã€Drainer åœ¨ PD ä¸­çš„çŠ¶æ€
   2. ä½¿ç”¨ pd-ctl å·¥å…·æŸ¥ PD cluster id ï¼Œåˆ¤æ–­ Drainer åŒæ­¥çš„é‚£ä¸ªé›†ç¾¤

### status api

- èŽ·å– pump binlog æ–‡ä»¶æ•°é‡ä¿¡æ¯ï¼Œè¯·æ±‚åœ°å€ä¸º pump ip:port
  - `curl  10.10.1.4:8250/status`
- èŽ·å– Drainer åŒæ­¥ä¿¡æ¯ï¼Œä»¥åŠåŒæ­¥ä½ç½®æ–­ç‚¹è®°å½•
  - `curl  10.10.1.4:8249/status`

### case one

> åˆ†äº«ä¸€ä¸ªå› ä¸ºåšäº†å¾ˆå¤šéçš„ðŸ¦æµ‹è¯•ï¼Œé€ æˆ Drainer æ— æ³•å¯åŠ¨çš„æŽ’æŸ¥è¿‡ç¨‹

- é€šè¿‡ drainer èŽ·å– savepoint æŠ¥é”™
  - `./bin/drainer -gen-savepoint -data-dir ./s -pd-urls "http://10.10.1.6:2379"`
  - é€šè¿‡ Drainer å…ˆè¡ŒèŽ·å– tso æ–­ç‚¹ä¿¡æ¯æ—¶å¤±è´¥ï¼Œæç¤ºæœ‰ä¸ª pump èŠ‚ç‚¹ ip-10-10-1-6:8250 æ˜¯ç¦»çº¿çŠ¶æ€ ã€åªæœ‰æ‰€æœ‰ PUMP éƒ½åœ¨çº¿æ—¶ï¼ŒDrainer æ‰å¯ä»¥å¯åŠ¨ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ•°æ®å®Œæ•´æ€§ã€‘  

    ```shell
    INFO[0000] new store
    INFO[0000] [pd] create pd client with endpoints [10.30.1.6:2379]
    INFO[0000] [pd] leader switches to: http://10.30.1.5:2379, previous:
    INFO[0000] [pd] init cluster id 6493070954582498647
    2017/12/27 16:35:15 main.go:31: [fatal] fail to generate savepoint error pump &{NodeID:ip-10-10-1-6:8250 Host:10.30.1.6:8250 IsAlive:false LatestBinlogFile:binlog-0000000000000000} is offline
    ```

- é€šè¿‡ curl å‘½ä»¤è¯·æ±‚ PUMP çŠ¶æ€å¾—åˆ°ä»¥ä¸‹ç»“æžœã€PUMP çŠ¶æ€æŽ¥å£å¯ä»¥çœ‹åˆ°é‚»å±…çš„çŠ¶æ€ã€‘  
  - `curl  10.10.1.6:8250/status`
  - çœ‹åˆ°é‚»å±…å…„å¼Ÿéƒ½æ˜¯å­˜æ´»çš„â€¦â€¦  

  ```shell
  {"LatestBinlog":{"ip-10-10-1-6:8250":{},"ip-10-10-1-7:8250":{},"tidb-online-tidb-1:8250":{"suffix":81},"tidb-online-tidb-2:8250":{"suffix":77},"tidb-online-tidb-3:8250":{"suffix":80},"tidb-online-tidb-4:8250":{"suffix":80}},"CommitTS":396981399817027585,"ErrMsg":""}
  ```

- å®˜æ–¹å¤§ä½¬æç¤ºï¼šè§‚å¯Ÿ data.pump ä¸‹ node æ–‡ä»¶å†…å®¹  
  - æ­¤å¤„çš„ .node  æ–‡ä»¶å†…å®¹å°±æ˜¯ PUMP ID ä¿¡æ¯ï¼›å›žé¡¾ä¸‹æŠ¥é”™æ—¥å¿— `pump &{NodeID:ip-10-10-1-6:8250 Host:10.30.1.6:8250` ï¼Œå‘çŽ°æ–‡ä»¶å†…å®¹ä¸ŽæŠ¥é”™å¯¹ä¸èµ·æ¥ã€‚çœ‹èµ·æ¥æ˜¯è¿™ä¸ªé—®é¢˜  

  ```shell
  cat /data1/tidb/deploy/data.pump/.node
  tidb-online-tidb-2:8250
  ```

- éœ€è¦ç”¨åˆ°ä¸€ä¸ªç¥žå¥‡çš„å·¥ï¼ˆ etcd-ctlï¼‰åŽ» PD-server åˆ é™¤è¿™ä¸ªæ— æ•ˆçš„ ID ä¿¡æ¯  
  - é€šè¿‡ etcd åˆ é™¤ `ip-10-10-1-6:8250` ä¸Ž `ip-10-10-1-7:8250`

  ```sehll
  export ETCDCTL_API=3 // é…ç½® etcd api ç‰ˆæœ¬ä¿¡æ¯

  #åœ¨ github etcd repo ä¸‹è½½ etcd-v3.2.9-linux-amd64.tar.gz

  ./etcdctl --endpoints=http://10.10.1.6:2379 get --prefix  tidb-binlog  
    // èŽ·å–æ‰€æœ‰ tidb-binlog keyä¿¡æ¯

  ./etcdctl --endpoints=http://10.10.1.6:2379 get tidb-binlog/pumps/ip-10-10-1-6:8250/object
    // èŽ·å–æŒ‡å®š object ä¿¡æ¯ï¼ŒéªŒè¯å…¶æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦è¿˜æœ‰å­é›†

  ./etcdctl --endpoints=http://10.10.1.6:2379 del tidb-binlog/pumps/ip-10-10-1-6:8250/object 
    // åˆ é™¤æŒ‡å®š object ä¿¡æ¯
  ```

- æ€»ç»“
  - é€ æˆè¿™ç§é—®é¢˜çš„åŽŸå› å¤§æ¦‚æ˜¯ï¼šæ²¡æœ‰æ­£å¸¸çš„åœæ­¢ PUMP èŠ‚ç‚¹ï¼Œæ¯”å¦‚ä½¿ç”¨ kill -9 çš„æ–¹å¼åœæ­¢ï¼ŒPUMP è¿›ç¨‹åœ¨æ­£å¸¸é€€å‡ºçš„æ—¶å€™ä¼šè‡ªåŠ¨åŽ» PD èŠ‚ç‚¹æ‰§è¡Œ offline å’Œæ¸…ç†è‡ªèº« ID çš„åŠ¨ä½œï¼Œä½†å¼‚å¸¸æƒ…å†µä¸‹æ— æ³•æ¸…ç†ï¼Œè¾£ä¹ˆé€ æˆçš„åžƒåœ¾æ•°æ®å°±ä¼šå½±å“ Drainer çš„è¿è¡Œäº†ã€‚

## 0x04 å¿’å‚»

### ç›‘æŽ§

> æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªç›‘æŽ§é¡¹ï¼ˆå®žé™…ä¸Šå°±çœ‹åˆ°äº†è¿™å‡ ä¸ªï¼‰

- RPC QPS(pump)
  - `irate(binlog_pump_rpc_counter[1m])`
  - pump rpc æŽ¥å£å¹³å‡æ¯åˆ†é’Ÿè°ƒç”¨æ¬¡æ•°

- 95% RPC Latency(pump)
  - pump rpc è¯·æ±‚ 95% å¹³å‡å»¶è¿Ÿ
  - `histogram_quantile(0.95, rate(binlog_pump_rpc_duration_seconds_bucket[1m]))`

- slave  lower boundary
  - drainer å·²ç»æŽ’åºå¤„ç†çš„äº‹åŠ¡çš„æœ€å¤§ TS ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºæœ€å¤§äº‹åŠ¡ IDï¼‰
  - `binlog_drainer_window{marker=\"lower\", }/(2^18*10^3)`

- slave position
  - drainer åŒæ­¥åˆ° ts
  - `binlog_drainer_position{}/((2^18)*1000)`

- error binlogs
  - é”™è¯¯çš„ binlog ä¸ªæ•°
  - `binlog_drainer_error_binlog_count{}`

- slave tikv query
  - drainer æŸ¥è¯¢ tikv è¯·æ±‚æ•°é‡
  - `binlog_drainer_query_tikv_count{}`

- synchronization delay
  - drainer æ•°æ®åŒæ­¥å»¶è¿Ÿæ—¶é—´ï¼Œå•ä½ç§’
  - `(binlog_drainer_window{marker=\"upper\", } - ignoring(marker)binlog_drainer_position{})/(2^18*10^3)`

- Drainer Event
  - drainer æ•°æ®åŒæ­¥ sql è¯­å¥ç±»åž‹çš„æ•°é‡
  - `rate(binlog_drainer_event{}[1m])`

- 99% drainer txn latency
  - .99 åŒæ­¥ binlog txn å»¶è¿Ÿæ—¶é—´
  - `histogram_quantile(0.99, rate(binlog_drainer_txn_duration_time_bucket[1m]))`

- Goroutine
  - binlog ç›®å‰å­˜åœ¨çš„go routinesæ•°é‡ã€‚
  - `go_goroutines{job=\"binlog\"}`

- Memory
  - æŸ¥çœ‹ Binlog ç»„ä»¶å ç”¨çš„å†…å­˜æ•°é‡ï¼Œä½¿ç”¨çš„ go å†…ç½®ç»Ÿè®¡ï¼Œè€Œéž linux ç³»ç»Ÿç»Ÿè®¡
  - `go_memstats_heap_inuse_bytes{job=\"binlog\"}`

## 0x05 å·¥å…·äºº

> æˆ‘æ˜¯ä¸€ä¸ªå†·é…·æ— æƒ…çš„å·¥å…·äººï¼Œè’¸è…¾åˆ°æ­»äº†

![æŠ˜è…¾åˆ°æ­»æ–¹ä¼‘æ­¢](/global/helpertools.jpg)
